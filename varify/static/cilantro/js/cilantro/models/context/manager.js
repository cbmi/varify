var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};define(["underscore","backbone","../../core","./nodes"],function(t,e,i,n){var s,o;return t.extend((o=function(){function t(){}return t}()).prototype,e.Events),s=function(e){function s(e,i){this.model=e,this.options=t.extend({},this.options,i),this.working=new n.BranchNodeModel(null,{manager:this}),this.upstream=new n.BranchNodeModel(null,{manager:this}),this.set(this.model.get("json"))}return __extends(s,e),s.prototype.options={identKeys:["concept","field","operator"]},s.prototype.toJSON=function(){return this.upstream.toJSON()},s.prototype._getRequired=function(){return i.config.get("query.concepts.required",[])},s.prototype._isRequired=function(t){var e;return e=t.get("concept"),this._getRequired().indexOf(e)>-1},s.prototype._triggerRequired=function(t){var e;return i.trigger(i.CONTEXT_REQUIRED,function(){var i,n,s;for(s=[],i=0,n=t.length;n>i;i++)e=t[i],s.push({concept:e,reason:"required"});return s}())},s.prototype._checkRequired=function(){var t,e,n,s,o,r,a,h,l;for(e=[],a=this._getRequired(),o=0,r=a.length;r>o;o++)t=a[o],(n=this.find({concept:t}))?n.isValid()?n.get("enabled")===!1&&(s="disabled"):s="invalid":s="undefined",s&&e.push({concept:t,reason:s});return e.length?(i.trigger(i.CONTEXT_INVALID,e),null!=(h=i.session)&&(h.state.context_invalid=!0),!1):(null!=(l=i.session)&&(l.state.context_invalid=void 0),!0)},s.prototype._set=function(t,e,i){return null!=e.concept||null!=e.field?t.children.add(e,i):t.set(e,i)},s.prototype.set=function(t,e){return null==e&&(e={}),e.reset&&(this.upstream.clear({reset:!0}),this.working.clear()),null==t?this.clear():(this._set(this.upstream,t,{manager:this,identKeys:this.options.identKeys,validate:!1,remove:!1}),this._set(this.working,t,{manager:this,identKeys:this.options.identKeys,validate:!1,remove:!1}))},s.prototype.find=function(t,e){return t=("function"==typeof t.identity?t.identity():void 0)||t,this.working.find(t,e)},s.prototype.define=function(t,e){return this.working.define(t,e)},s.prototype.save=function(e,i){return null==e&&(e=this.upstream),i=t.extend({},i,{beforeSend:function(t){return e.trigger("request",e,t,i)}}),this.model.save(null,i).done(function(){return e.trigger("sync",e,e.toJSON(),i)}).fail(function(t){return e.trigger("error",e,t,i)})},s.prototype.remove=function(t){var e,i;return t=("function"==typeof t.identity?t.identity():void 0)||t,(e=this.find(t))?this._isRequired(e)?(this._triggerRequired([e.get("concept")]),!1):this._checkRequired()?(i=this.upstream.find(t))?(i.destroy(),e.trigger("remove"),i.trigger("remove"),this.save(e)):void 0:!1:!1},s.prototype.apply=function(t,e){var i,n,s;return t=("function"==typeof t.identity?t.identity():void 0)||t,this._checkRequired()?(n=this.find(t))?(i=n.toJSON())?(s=this.upstream.define(t,n.path(),{type:n.type}),s.set(i,e),s.hasChanged()?(n.trigger("apply"),s.trigger("apply"),this.save(s)):void 0):!1:!1:!1},s.prototype.revert=function(t){var e,i;return t=("function"==typeof t.identity?t.identity():void 0)||t,(e=this.find(t))?(i=this.upstream.find(t))?(e.set(i.toJSON(),{remove:!1}),e.hasChanged()?(e.trigger("revert"),i.trigger("revert")):void 0):e.clear():void 0},s.prototype.enable=function(t){var e,i;return t=("function"==typeof t.identity?t.identity():void 0)||t,(e=this.find(t))?(i=this.upstream.find(t))&&(i.set({enabled:!0}),i.hasChanged("enabled"))?(e.trigger("enable"),i.trigger("enable"),this.save(i)):void 0:void 0},s.prototype.disable=function(t){var e,i;return t=("function"==typeof t.identity?t.identity():void 0)||t,(e=this.find(t))?this._isRequired(e)?(this._triggerRequired([e.get("concept")]),!1):this._checkRequired()?(i=this.upstream.find(t))&&(i.set({enabled:!1}),i.hasChanged("enabled"))?(e.trigger("disable"),i.trigger("disable"),this.save(i)):void 0:!1:!1},s.prototype.clear=function(t){var e;return null==t&&(t={}),(e=this._getRequired()).length?(this._triggerRequired(e),!1):(this.upstream.clear({reset:!0}),this.upstream.trigger("clear"),this.working.trigger("clear"),this.upstream.hasChanged()?this.save():void 0)},s.prototype.isNew=function(t){return t=("function"==typeof t.identity?t.identity():void 0)||t,!this.upstream.find(t)},s.prototype.isDirty=function(e){var i;return e=("function"==typeof e.identity?e.identity():void 0)||e,(i=this.upstream.find(e))?!t.isEqual(i.toJSON(),this.find(e).toJSON()):!1},s.prototype.isEnabled=function(t){var e;return t=("function"==typeof t.identity?t.identity():void 0)||t,(e=this.upstream.find(t))?e.get("enabled")!==!1:!1},s}(o),{ContextTreeManager:s}});
//@ sourceMappingURL=manager.js.map